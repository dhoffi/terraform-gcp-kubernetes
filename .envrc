#!/bin/bash

unset DEST
PS3='choose destination environment: '
options=("devtest" "qa" "prod")
select opt in "${options[@]}"
do
    case $opt in
        "qa")
            ;&
        "devtest")
            export DEST=$opt
            echo -e "you chose $REPLY which is \e[1;33m$opt\e[0m"
            break
            ;;
        "prod")
            export DEST=$opt
            echo -e "you chose $REPLY which is \e[1;31m$opt\e[0m"
            break
            ;;
        *)
            echo "invalid option '$REPLY'!"
            break
            ;;
    esac
done

if [ -z "$DEST" ]; then echo "aborting ... not source .envrc" ; exit -1 ; fi

gcloud config configurations activate ${DEST}-myk8spray 2> /dev/null
source ./bash_aliases

#  ( consider using https://direnv.net )
# variables prefixed with 'TF_VAR_' can be used in terraform files (without the prefix)

export REPO_ROOT_DIR="$(pwd)"
export TF_VAR_PROJECT_ID=$(gcloud config get-value project)
export TF_VAR_ADMIN_NAME=${DEST}-tu-k8s
export TF_ADMIN=${TF_VAR_ADMIN_NAME}@${TF_VAR_PROJECT_ID}.iam.gserviceaccount.com

export TF_VAR_GCP_PROJECT_SERVICE_ACCOUNT_FILE="${REPO_ROOT_DIR}/secrets/${TF_VAR_PROJECT_ID}_${TF_VAR_ADMIN_NAME}.json"
export GOOGLE_APPLICATION_CREDENTIALS=${TF_VAR_GCP_PROJECT_SERVICE_ACCOUNT_FILE}
export TF_VAR_GCP_REGION=$(gcloud config get-value compute/region)
export TF_VAR_GCP_ZONE=$(gcloud config get-value compute/zone)
# export TF_VAR_org_id=YOUR_ORG_ID
# export TF_VAR_billing_account=YOUR_BILLING_ACCOUNT_ID
export TF_VAR_TF_STATE_BUCKET="terraform-state-${TF_VAR_PROJECT_ID}"
